<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لعبة عالم مفتوح - مطعمي الجزائري</title>
  <style>
    :root{--bg:#eaf5e9;--floor:#f8f4ef;--counter:#d35400;--player:#1f8ef1}
    *{box-sizing:border-box;font-family: 'Segoe UI', Tahoma, Arial, sans-serif}
    body{margin:0;background:var(--bg);color:#222}
    #app{max-width:1100px;margin:18px auto;padding:12px}
    header{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px}
    #gameWrap{display:flex;gap:12px;margin-top:12px}
    #game{background:var(--floor);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.08)}
    #ui{width:300px}
    .panel{background:white;padding:12px;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,0.06)}
    canvas{display:block;border-radius:8px}
    .controls{margin-top:10px;color:#555;font-size:14px}
    .stat{font-weight:700}
    button{padding:8px;border-radius:8px;border:0;background:var(--counter);color:white;cursor:pointer}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>لعبة عالم مفتوح — مطعمي الجزائري</h1>
      <div style="margin-left:auto">تحكم: أسهم / WASD — تفاعل: E</div>
    </header>

    <div id="gameWrap">
      <div id="game">
        <canvas id="canvas" width="800" height="600"></canvas>
      </div>

      <aside id="ui" class="panel">
        <div>النقود: <span id="money" class="stat">0 DA</span></div>
        <div>السمعة: <span id="rep" class="stat">0</span></div>
        <div>الزمن: <span id="time">0</span>s</div>
        <hr />
        <div>حالة اللاعب: <span id="playerState">سَلامة</span></div>
        <div style="margin-top:8px">أوامر:</div>
        <div class="controls">
          - امشِ في العالم، اجمع مكونات، اطبخ، وبيع للزبائن الذين سيأتون عشوائياً.
          - اقترب من العداد و اضغط E لبيع وجبة جاهزة.
        </div>
        <hr />
        <button id="spawnGuest">أنشئ زبون الآن</button>
        <div style="margin-top:10px;color:#666;font-size:13px">مُطوّر: النسخة الأساسية (2D). اطلب مني إضافة خرائط أكبر، مهام، أو إصلاحات.</div>
      </aside>
    </div>
  </div>

  <script>
  /* لعبة عالم مفتوح مبسطة: خريطة صغيرة، حركة اللاعب، زبائن يأتون، عداد بيع. */

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // حالة اللعبة
  const state = {
    time:0,
    money:0,
    rep:0,
    player:{x:400,y:300,w:22,h:28,spd:140, dirX:0, dirY:0},
    map:{},
    dishes:[],
    customers:[],
    lastSpawn:0
  };

  // نقاط تفاعل على الخريطة
  const COUNTER = {x:360,y:80,w:160,h:60}; // عداد البيع
  const KITCHEN = {x:60,y:420,w:160,h:120}; // منطقة الطهي/جمع المكونات

  // توليد عناصر العالم (أشجار، طاولات) - فقط للعرض
  const decor = [];
  for(let i=0;i<16;i++){decor.push({x:Math.random()*(W-40)+20,y:Math.random()*(H-180)+120,r:6+Math.random()*10});}

  // مفاتيح
  const keys = {};
  window.addEventListener('keydown', e=>{ keys[e.key.toLowerCase()] = true; });
  window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });

  // الواجهة
  const moneyEl = document.getElementById('money');
  const repEl = document.getElementById('rep');
  const timeEl = document.getElementById('time');
  const playerStateEl = document.getElementById('playerState');

  // زبون
  function createCustomer(){
    const edge = Math.random();
    let x = edge<0.5? (edge<0.25? 10 : W-10) : Math.random()*W;
    let y = edge<0.5? Math.random()*H : (edge<0.75? 10 : H-10);
    const want = ['كسكس','شربة','طاجين','محاجب'][Math.floor(Math.random()*4)];
    const patience = 20 + Math.floor(Math.random()*40);
    state.customers.push({id:Date.now()+Math.random(),x,y,w:18,h:24, want, patience, maxPatience:patience, state:'walking', target:{x:COUNTER.x+COUNTER.w/2,y:COUNTER.y+COUNTER.h+20}});
  }

  document.getElementById('spawnGuest').onclick = ()=> createCustomer();

  // بسيط: عندما يطبخ اللاعب داخل KITCHEN يضيف طبق جاهز
  function tryCook(dt){
    const p = state.player;
    if(rectIntersect(p,KITCHEN)){
      // عند الضغط على "e" نطبخ طبق و نضيفه
      if(keys['e']){
        // ضغطة واحدة لتجنب التكرار المستمر
        if(!p._lastE){
          p._lastE = true;
          // صنع طبق عشوائي
          const dish = {name: ['كسكس','شربة','طاجين','محاجب'][Math.floor(Math.random()*4)], price: 20+Math.floor(Math.random()*25), ready:true};
          state.dishes.push(dish);
          // صوت وهمي / إعلام
          playerStateEl.textContent = 'طهى: ' + dish.name;
        }
      } else p._lastE = false;
    }
  }

  // تقديم للزبون عندما تكون عند العداد
  function tryServe(){
    const p = state.player;
    if(keys['e'] && rectIntersect(p,COUNTER)){
      if(!p._lastE2){
        p._lastE2 = true;
        if(state.dishes.length === 0){ playerStateEl.textContent = 'لا يوجد أطباق جاهزة'; return; }
        // اختر زبون ينتظر
        const cust = state.customers.find(c=>distance(c, {x:COUNTER.x+COUNTER.w/2,y:COUNTER.y+COUNTER.h/2}) < 120);
        if(!cust){ playerStateEl.textContent = 'لا أحد عند العداد حالياً'; return; }
        // قدم أول طبق و تحقق
        const dish = state.dishes.shift();
        if(dish.name === cust.want){
          state.money += dish.price;
          state.rep += 2;
          playerStateEl.textContent = 'بيع ناجح: ' + dish.name;
          // ازالة الزبون
          state.customers = state.customers.filter(c=>c.id!==cust.id);
        } else {
          // بيع خاطئ يؤدي لتقليل السمعة
          state.money += Math.round(dish.price*0.5);
          state.rep -= 1;
          playerStateEl.textContent = 'الزبون غير راضٍ (طلب: '+cust.want+')';
          state.customers = state.customers.filter(c=>c.id!==cust.id);
        }
      }
    } else p._lastE2 = false;
    updateUI();
  }

  function updateUI(){
    moneyEl.textContent = state.money + ' DA';
    repEl.textContent = state.rep;
    timeEl.textContent = Math.floor(state.time);
  }

  function rectIntersect(a,b){ return !(a.x+a.w < b.x || a.x > b.x+b.w || a.y+a.h < b.y || a.y > b.y+b.h); }
  function distance(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy); }

  // تحديث Zبائن بسيط: المشي نحو العداد، نفاد الصبر
  function updateCustomers(dt){
    for(let i=state.customers.length-1;i>=0;i--){
      const c = state.customers[i];
      // المشي نحو الهدف
      const dx = c.target.x - c.x; const dy = c.target.y - c.y; const dist = Math.sqrt(dx*dx+dy*dy);
      if(dist > 3){ c.x += (dx/dist) * 60 * dt; c.y += (dy/dist) * 60 * dt; }
      else { // وصل — ينتظر
        c.state = 'waiting';
        c.patience -= dt;
        if(c.patience <= 0){ // يغادر و يقل السمعة
          state.customers.splice(i,1);
          state.rep -= 2;
        }
      }
    }
  }

  // رسم العالم
  function draw(){
    ctx.clearRect(0,0,W,H);
    // أرض
    ctx.fillStyle = '#f6efe6'; ctx.fillRect(0,0,W,H);
    // ديكور
    decor.forEach(d=>{ ctx.beginPath(); ctx.fillStyle='#c8e6c9'; ctx.arc(d.x,d.y,d.r,0,Math.PI*2); ctx.fill(); });

    // عداد البيع
    ctx.fillStyle = '#d35400'; ctx.fillRect(COUNTER.x,COUNTER.y,COUNTER.w,COUNTER.h);
    ctx.fillStyle = 'white'; ctx.font='16px Arial'; ctx.fillText('العداد', COUNTER.x+10, COUNTER.y+36);

    // المطبخ
    ctx.fillStyle = '#f0c987'; ctx.fillRect(KITCHEN.x,KITCHEN.y,KITCHEN.w,KITCHEN.h);
    ctx.fillStyle='#663e0a'; ctx.fillText('مطبخ / جمع مكونات (E)', KITCHEN.x+8, KITCHEN.y+22);

    // رسمة الأطباق الجاهزة بجانب اللاعب
    ctx.fillStyle='#000'; ctx.font='13px Arial'; ctx.fillText('أطباق جاهزة: ' + state.dishes.length, 12, 18);

    // زبائن
    state.customers.forEach(c=>{
      ctx.fillStyle = '#ffefc5'; ctx.fillRect(c.x-c.w/2,c.y-c.h/2,c.w,c.h);
      ctx.fillStyle='#333'; ctx.font='11px Arial'; ctx.fillText(c.want, c.x-14, c.y-12);
      // شريط صبر
      const pct = c.patience / c.maxPatience;
      ctx.fillStyle = '#ddd'; ctx.fillRect(c.x-18, c.y+10, 36,6);
      ctx.fillStyle = pct>0.5? '#4caf50' : (pct>0.2? '#ffb300' : '#e53935');
      ctx.fillRect(c.x-18, c.y+10, 36*pct,6);
    });

    // اللاعب
    const p = state.player;
    ctx.fillStyle = '#1f8ef1'; ctx.fillRect(p.x-p.w/2, p.y-p.h/2, p.w, p.h);
    ctx.fillStyle='#fff'; ctx.font='12px Arial'; ctx.fillText('أنت', p.x-10, p.y+4);

    // حدود
    ctx.strokeStyle='rgba(0,0,0,0.05)'; ctx.strokeRect(0,0,W,H);
  }

  // تحديث كل فريم
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.05, (now-last)/1000);
    last = now;
    state.time += dt;

    // حركة اللاعب
    const p = state.player;
    let moveX = 0, moveY = 0;
    if(keys['arrowup'] || keys['w']) moveY = -1;
    if(keys['arrowdown'] || keys['s']) moveY = 1;
    if(keys['arrowleft'] || keys['a']) moveX = -1;
    if(keys['arrowright'] || keys['d']) moveX = 1;
    // normalize
    if(moveX !==0 || moveY !==0){ const len = Math.sqrt(moveX*moveX + moveY*moveY); moveX/=len; moveY/=len; }
    p.x += moveX * p.spd * dt; p.y += moveY * p.spd * dt;
    // حواجز حدودية
    p.x = Math.max(p.w/2, Math.min(W-p.w/2, p.x));
    p.y = Math.max(p.h/2, Math.min(H-p.h/2, p.y));

    tryCook(dt);
    tryServe();
    updateCustomers(dt);

    // توليد زبائن كل 6-12 ثانية
    if(state.time - state.lastSpawn > 6 + Math.random()*6){ createCustomer(); state.lastSpawn = state.time; }

    draw(); updateUI();
    requestAnimationFrame(loop);
  }

  // بدء اللعب
  updateUI(); requestAnimationFrame(loop);

  </script>
</body>
</html>
